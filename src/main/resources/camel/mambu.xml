<?xml version="1.0" encoding="UTF-8"?>
<routes id="mambuRoutes"
        xmlns="http://camel.apache.org/schema/spring"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
            http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd">
    <route id="findBranchesRoute" routeConfigurationId="*">
        <from uri="direct:findBranches"/>
        <setProperty name="flowId">
            <simple>${routeId}:${id}</simple>
        </setProperty>
        <setBody><constant>{}</constant></setBody>
        <to uri="direct:startRoute"/>
        <log message="== findBranches Route"/>
        <setHeader name="CamelHttpMethod">
            <constant>GET</constant>
        </setHeader>
         <!-- Use processor to set the auth header  -->
        <setProperty name="authHeader">
            <simple>{{mambu.username}}:{{mambu.password}}</simple>
        </setProperty>
        <process ref="encodeAuthHeader" />

        <log message="GET branches request is ${body}"/>
        <to uri="https://{{mambu.host}}/api/branches?throwExceptionOnFailure=false&amp;bridgeEndpoint=true"/>
        <log message="GET branches response is ${body}"/>
        <to uri="direct:endRoute"/>
    </route>
    <route id="findDepositProductsRoute" routeConfigurationId="*">
        <from uri="direct:findDepositProducts"/>
        <setProperty name="flowId">
            <simple>${routeId}:${id}</simple>
        </setProperty>
        <setBody><constant>{}</constant></setBody>
        <to uri="direct:startRoute"/>
        <log message="== findDepositProducts Route"/>
        <setHeader name="CamelHttpMethod">
            <constant>GET</constant>
        </setHeader>
        <setHeader name="Accept">
            <constant>application/vnd.mambu.v2+json</constant>
        </setHeader>
         <!-- Use processor to set the auth header  -->
        <setProperty name="authHeader">
            <simple>{{mambu.username}}:{{mambu.password}}</simple>
        </setProperty>
        <process ref="encodeAuthHeader" />

        <log message="GET depositproducts request is ${body}"/>
        <to uri="https://{{mambu.host}}/api/depositproducts?detailsLevel=FULL&amp;throwExceptionOnFailure=false&amp;bridgeEndpoint=true"/>
        <log message="GET depositproducts response is ${body}"/>
        <to uri="direct:endRoute"/>
    </route>
    <route id="findPersonRoute" routeConfigurationId="*">
        <from uri="direct:findPerson"/>
        <setProperty name="flowId">
            <simple>${routeId}:${id}</simple>
        </setProperty>
        <setBody><constant>{}</constant></setBody>
        <to uri="direct:startRoute"/>
        <log message="== findPerson Route"/>
        <setHeader name="CamelHttpMethod">
            <constant>GET</constant>
        </setHeader>
        <setHeader name="Accept">
            <constant>application/vnd.mambu.v2+json</constant>
        </setHeader>
        <!-- Use processor to set the auth header  -->
        <setProperty name="authHeader">
            <simple>{{mambu.username}}:{{mambu.password}}</simple>
        </setProperty>
        <process ref="encodeAuthHeader" />

        <log message="GET clients with id: ${header.partyId}"/>
        <toD uri="https://{{mambu.host}}/api/clients/${header.partyId}?throwExceptionOnFailure=false&amp;bridgeEndpoint=true"/>
        <log message="GET clients response is ${body}"/>
        <to uri="direct:endRoute"/>
    </route>
    <route id="createPersonRoute" routeConfigurationId="*">
        <from uri="direct:createPerson"/>
        <setProperty name="flowId">
            <simple>${routeId}:${id}</simple>
        </setProperty>
<!--        <to uri="direct:startRoute"/>-->
        <log message="== createPerson Route"/>
        <setHeader name="CamelHttpMethod">
            <constant>POST</constant>
        </setHeader>
        <setHeader name="Accept">
            <constant>application/vnd.mambu.v2+json</constant>
        </setHeader>
        <!-- Use processor to set the auth header  -->
        <setProperty name="authHeader">
            <simple>{{mambu.username}}:{{mambu.password}}</simple>
        </setProperty>
        <process ref="encodeAuthHeader" />
        <setBody>
            <datasonnet bodyMediaType="application/json" outputMediaType="application/json" resultType="java.lang.String">
                resource:classpath:mappings/CreateClientsRequest.ds
            </datasonnet>
        </setBody>
        <log message="POST clients with request: ${body}"/>
        <toD uri="https://{{mambu.host}}/api/clients?throwExceptionOnFailure=false&amp;bridgeEndpoint=true"/>
        <log message="POST clients response is ${body}"/>
<!--        <to uri="direct:endRoute"/>-->
    </route>
    <route id="updatePersonRoute" routeConfigurationId="*">
        <from uri="direct:updatePerson"/>
        <setProperty name="flowId">
            <simple>${routeId}:${id}</simple>
        </setProperty>
        <to uri="direct:startRoute"/>
        <log message="== updatePerson Route"/>
        <setHeader name="CamelHttpMethod">
            <constant>PUT</constant>
        </setHeader>
        <setHeader name="Accept">
            <constant>application/vnd.mambu.v2+json</constant>
        </setHeader>
        <!-- Use processor to set the auth header  -->
        <setProperty name="authHeader">
            <simple>{{mambu.username}}:{{mambu.password}}</simple>
        </setProperty>
        <process ref="encodeAuthHeader" />

        <log message="PUT clients with request: ${body}"/>
        <toD uri="https://{{mambu.host}}/api/clients/${header.partyId}?throwExceptionOnFailure=false&amp;bridgeEndpoint=true"/>
        <log message="PUT clients response is ${body}"/>
        <to uri="direct:endRoute"/>
    </route>
    <route id="findAccountRoute" routeConfigurationId="*">
        <from uri="direct:findAccount"/>
        <setProperty name="flowId">
            <simple>${routeId}:${id}</simple>
        </setProperty>
        <setBody><constant>{}</constant></setBody>
<!--        <to uri="direct:startRoute"/>-->
        <log message="== findAccount Route"/>
        <setHeader name="CamelHttpMethod">
            <constant>GET</constant>
        </setHeader>
        <setHeader name="Accept">
            <constant>application/vnd.mambu.v2+json</constant>
        </setHeader>
        <!-- Use processor to set the auth header  -->
        <setProperty name="authHeader">
            <simple>{{mambu.username}}:{{mambu.password}}</simple>
        </setProperty>
        <process ref="encodeAuthHeader" />

        <log message="GET deposits with id: ${header.accountId}"/>
        <toD uri="https://{{mambu.host}}/api/deposits/${header.accountId}?throwExceptionOnFailure=false&amp;bridgeEndpoint=true"/>
        <log message="GET deposits response is ${body}"/>
<!--        <to uri="direct:endRoute"/>-->
    </route>
    <route id="findDepositAccountBalancesRoute" routeConfigurationId="*">
        <from uri="direct:findDepositAccountBalances"/>
        <setProperty name="flowId">
            <simple>${routeId}:${id}</simple>
        </setProperty>
        <setBody><constant>{}</constant></setBody>
        <!--        <to uri="direct:startRoute"/>-->
        <log message="== findDepositAccountBalances Route"/>
        <setHeader name="CamelHttpMethod">
            <constant>GET</constant>
        </setHeader>
        <setHeader name="Accept">
            <constant>application/vnd.mambu.v2+json</constant>
        </setHeader>
        <!-- Use processor to set the auth header  -->
        <setProperty name="authHeader">
            <simple>{{mambu.username}}:{{mambu.password}}</simple>
        </setProperty>
        <process ref="encodeAuthHeader" />

        <log message="GET deposits with id: ${header.accountId}"/>
        <toD uri="https://{{mambu.host}}/api/deposits/${header.accountId}?throwExceptionOnFailure=false&amp;bridgeEndpoint=true"/>
        <log message="GET deposits response is ${body}"/>
        <setBody>
            <datasonnet bodyMediaType="application/json" outputMediaType="application/json" resultType="java.lang.String">
                body.balances
            </datasonnet>
        </setBody>
        <!--        <to uri="direct:endRoute"/>-->
    </route>
    <route id="openBankingAccountRoute" routeConfigurationId="*">
        <from uri="direct:openBankingAccount"/>
        <setProperty name="flowId">
            <simple>${routeId}:${id}</simple>
        </setProperty>
<!--        <to uri="direct:startRoute"/>-->
        <log message="== openBankingAccount Route"/>
        <setHeader name="CamelHttpMethod">
            <constant>POST</constant>
        </setHeader>
        <setHeader name="Accept">
            <constant>application/vnd.mambu.v2+json</constant>
        </setHeader>
        <!-- Use processor to set the auth header  -->
        <setProperty name="authHeader">
            <simple>{{mambu.username}}:{{mambu.password}}</simple>
        </setProperty>
        <process ref="encodeAuthHeader" />
        <setBody>
            <datasonnet bodyMediaType="application/json" outputMediaType="application/json" resultType="java.lang.String">
                resource:classpath:mappings/CreateDepositsRequest.ds
            </datasonnet>
        </setBody>
        <log message="POST deposits with request: ${body}"/>
        <toD uri="https://{{mambu.host}}/api/deposits?throwExceptionOnFailure=false&amp;bridgeEndpoint=true"/>
        <log message="POST deposits response is ${body}"/>
<!--        <to uri="direct:endRoute"/>-->
    </route>
    <route id="updateAccountRoute" routeConfigurationId="*">
        <from uri="direct:updateAccount"/>
        <setProperty name="flowId">
            <simple>${routeId}:${id}</simple>
        </setProperty>
        <to uri="direct:startRoute"/>
        <log message="== updateAccount Route"/>
        <setHeader name="CamelHttpMethod">
            <constant>PUT</constant>
        </setHeader>
        <setHeader name="Accept">
            <constant>application/vnd.mambu.v2+json</constant>
        </setHeader>
        <!-- Use processor to set the auth header  -->
        <setProperty name="authHeader">
            <simple>{{mambu.username}}:{{mambu.password}}</simple>
        </setProperty>
        <process ref="encodeAuthHeader" />

        <log message="PUT deposits with request: ${body}"/>
        <toD uri="https://{{mambu.host}}/api/deposits/${header.accountId}?throwExceptionOnFailure=false&amp;bridgeEndpoint=true"/>
        <log message="PUT deposits response is ${body}"/>
        <to uri="direct:endRoute"/>
    </route>
    <route id="findOrganizationRoute" routeConfigurationId="*">
        <from uri="direct:findOrganization"/>
        <setProperty name="flowId">
            <simple>${routeId}:${id}</simple>
        </setProperty>
        <setBody><constant>{}</constant></setBody>
        <to uri="direct:startRoute"/>
        <log message="== findOrganization Route"/>
        <setHeader name="CamelHttpMethod">
            <constant>GET</constant>
        </setHeader>
        <!-- Use processor to set the auth header  -->
        <setProperty name="authHeader">
            <simple>{{mambu.username}}:{{mambu.password}}</simple>
        </setProperty>
        <process ref="encodeAuthHeader" />

        <log message="GET groups with id: ${header.partyId}"/>
        <toD uri="https://{{mambu.host}}/api/groups/${header.partyId}?throwExceptionOnFailure=false&amp;bridgeEndpoint=true"/>
        <log message="GET groups response is ${body}"/>
        <to uri="direct:endRoute"/>
    </route>
    <route id="createOrganizationRoute" routeConfigurationId="*">
        <from uri="direct:createOrganization"/>
        <setProperty name="flowId">
            <simple>${routeId}:${id}</simple>
        </setProperty>
        <!--        <to uri="direct:startRoute"/>-->
        <log message="== createOrganization Route"/>
        <setHeader name="CamelHttpMethod">
            <constant>POST</constant>
        </setHeader>
        <setHeader name="Accept">
            <constant>application/vnd.mambu.v2+json</constant>
        </setHeader>
        <!-- Use processor to set the auth header  -->
        <setProperty name="authHeader">
            <simple>{{mambu.username}}:{{mambu.password}}</simple>
        </setProperty>
        <process ref="encodeAuthHeader" />
        <setBody>
            <datasonnet bodyMediaType="application/json" outputMediaType="application/json" resultType="java.lang.String">
                resource:classpath:mappings/CreateGroupsRequest.ds
            </datasonnet>
        </setBody>
        <log message="POST groups with request: ${body}"/>
        <toD uri="https://{{mambu.host}}/api/groups?throwExceptionOnFailure=false&amp;bridgeEndpoint=true"/>
        <log message="POST groups response is ${body}"/>
        <!--        <to uri="direct:endRoute"/>-->
    </route>
    <route id="updateOrganizationRoute" routeConfigurationId="*">
        <from uri="direct:updateOrganization"/>
        <setProperty name="flowId">
            <simple>${routeId}:${id}</simple>
        </setProperty>
        <to uri="direct:startRoute"/>
        <log message="== updateOrganization Route"/>
        <setHeader name="CamelHttpMethod">
            <constant>PUT</constant>
        </setHeader>
        <setHeader name="Accept">
            <constant>application/vnd.mambu.v2+json</constant>
        </setHeader>
        <!-- Use processor to set the auth header  -->
        <setProperty name="authHeader">
            <simple>{{mambu.username}}:{{mambu.password}}</simple>
        </setProperty>
        <process ref="encodeAuthHeader" />

        <log message="PUT groups with request: ${body}"/>
        <toD uri="https://{{mambu.host}}/api/groups/${header.partyId}?throwExceptionOnFailure=false&amp;bridgeEndpoint=true"/>
        <log message="PUT groups response is ${body}"/>
        <to uri="direct:endRoute"/>
    </route>
    <route id="testCreateBranchRoute" routeConfigurationId="*">
        <from uri="direct:testCreateBranch"/>
        <setProperty name="flowId">
            <simple>${routeId}:${id}</simple>
        </setProperty>
        <setHeader name="CamelHttpMethod">
            <constant>POST</constant>
        </setHeader>
        <to uri="https://{{mambu.host}}/api/branches"/>
        <choice>
            <when>
                <simple>${header.CamelHttpResponseCode} == 200</simple>
                <setBody><simple>${body}</simple></setBody>
            </when>
            <otherwise>
                <setBody>
                    <constant>null</constant>
                </setBody>
            </otherwise>
        </choice>
    </route>
    <route id="testUpdateBranchRoute" routeConfigurationId="*">
        <from uri="direct:testUpdateBranch"/>
        <setProperty name="flowId">
            <simple>${routeId}:${id}</simple>
        </setProperty>
        <setHeader name="CamelHttpMethod">
            <constant>PUT</constant>
        </setHeader>
        <to uri="https://{{mambu.host}}/api/branches/id"/>
        <choice>
            <when>
                <simple>${header.CamelHttpResponseCode} == 200</simple>
                <setBody><simple>${body}</simple></setBody>
            </when>
            <otherwise>
                <setBody>
                    <constant>null</constant>
                </setBody>
            </otherwise>
        </choice>
    </route>
    <!-- <route id="testDatabaseRoute" routeConfigurationId="*">
        <from uri="direct:testDatabase"/>
        <setProperty name="flowId">
            <simple>${routeId}:${id}</simple>
        </setProperty>
        <to uri="sql:select count(*) as cnt from person where last_name=# and status='A'?dataSource=#myDataSource"/>
        <log message="Result: ${body}:"/> 
    </route> -->
</routes>